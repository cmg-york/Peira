---
title: "The EmVoc framework for empirically evaluating modeling language vocabulary"
author: "Sotirios Liaskos"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, eval = TRUE)
source("PackageLoad.R")
```

# Preliminary: Load Libraries and Set Paths

```{r eval=TRUE}
require("knitr")
source("Library.R")
setwd("../Instrument/Generator/")
source("Preliminary.R")
setwd("../../Stats")
#dPath = "../Data/Pilot 1/Clean/"
dPath = "../Data/Main/Clean/"
mdPath = "../Instrument/InstrumentData/"
paperPath = "../../../../2R. Papers/2022TSE/"

printTEXData = FALSE
printIMGData = FALSE


expAlphaLevel = 0.05/5 # One piece for each AC, DEF, EXC, OV, Self
accExps = 10
defExps = 2
excExps = 3
ovExps = 2
selfExps = 3

testCount = accExps + defExps + excExps + ovExps + selfExps 


if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.0. testcount.tex"))
  cat(reportNumber(testCount))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.0. expAlphaLevel.tex"))
  cat(expAlphaLevel)
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.0. accExps.tex"))
  cat(reportNumber(accExps))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.0. accExps-bare.tex"))
  cat(accExps)
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.0.0. accExps-alpha.tex"))
  cat(expAlphaLevel/accExps)
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.0.0. defExps.tex"))
  cat(reportNumber(defExps))
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.0.0. excExps.tex"))
  cat(reportNumber(excExps))
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.0.0. ovExps.tex"))
  cat(reportNumber(ovExps))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.0. selfExps.tex"))
  cat(reportNumber(selfExps))
  sink(file = NULL)
}


```




# Read data and set dataframes

```{r eval=TRUE}

#read.csv(paste0(mdPath,"key.csv"))
gmo_data = getData("gmo",dPath,mdPath)
gme_data = getData("gme",dPath,mdPath)



#PROLIFIC BLOCKLIST
#paste(c(gmo_data[[4]][[1]] %>% pull(PROLIFIC_PID),gmo_data[[4]][[2]] %>% pull(PROLIFIC_PID)),collapse = ',')

#   E x p e r i m e n t a l  ( g m o )
# Observational Data
ds1 = gmo_data[[1]]
# Self reported Data
ds2 = gmo_data[[2]]
# Demographic Data
dse = gmo_data[[3]]

#   C o n t r o l  ( g m e )
# Observational Data
ds1.c = gme_data[[1]]
# Self reported Data
ds2.c = gme_data[[2]]
# Demographic Data
dse.c = gme_data[[3]]


gmo_clean = nrow(unique(gmo_data[[4]][["clean"]][,"PROLIFIC_PID"]))
gmo_unclean = nrow(unique(gmo_data[[4]][["unclean"]][,"PROLIFIC_PID"]))
gme_clean = nrow(unique(gme_data[[4]][["clean"]][,"PROLIFIC_PID"]))
gme_unclean = nrow(unique(gme_data[[4]][["unclean"]][,"PROLIFIC_PID"]))

totalInvited = gmo_clean + gmo_unclean + gme_clean + gme_unclean

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.1. totalInvited.tex"))
  cat(reportNumber(totalInvited))
  sink(file = NULL)
}

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.1. treatmentInvited.tex"))
  cat(reportNumber(totalInvited/2))
  sink(file = NULL)
}

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.1. gmoExcluded.tex"))
  cat(reportNumber(gmo_unclean))
  sink(file = NULL)
}

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.1. gmeExcluded.tex"))
  cat(reportNumber(gme_unclean))
  sink(file = NULL)
}


```


# Instrument Statistics

```{r }


instru.stats.1 = cbind(
ds1 %>% filter(auth == psy_option,description == 1) %>% group_by(participant,auth) %>% summarise(occs = n()) %>% 
  group_by(auth) %>% summarise(n2 =mean(occs)) %>% rename (Concept = auth, " # Elements" = n2) %>%
  mutate (Concept = factor(Concept, levels = c(lang$gmo$concepts,lang$gmo$relationships))) %>% arrange(Concept)
,
ds1 %>% filter(auth == psy_option,description == 2) %>% group_by(participant,auth) %>% summarise(occs = n()) %>% 
  group_by(auth) %>% summarise(n2 =mean(occs)) %>% rename (Concept = auth, " # Elements" = n2) %>%
  mutate (Concept = factor(Concept, levels = c(lang$gmo$concepts,lang$gmo$relationships))) %>% arrange(Concept))


instru.stats.2 = cbind(
ds1 %>% filter(auth == psy_option) %>% group_by(participant,auth) %>% summarise(occs = n()) %>% 
    group_by(auth) %>% summarise(n2 =mean(occs)) %>% rename (Concept = auth, " # Elements" = n2) %>%
    mutate (Concept = factor(Concept, levels = c(lang$gmo$concepts,lang$gmo$relationships))) %>% arrange(Concept)
,
ds1.c %>% filter(auth == psy_option) %>% group_by(participant,auth) %>% summarise(occs = n()) %>% 
    group_by(auth) %>% summarise(n2 =mean(occs)) %>% rename (Concept = auth, " # Elements" = n2) %>%
    mutate (Concept = factor(Concept, levels = c(lang$gme$concepts,lang$gme$relationships))) %>% arrange(Concept)
)


kable(instru.stats.1)


xtable(instru.stats.1
, caption = "Number of elements by case and authoritative designation."
, label = "tab:auths.case"
, digits= 0 
)


kable(instru.stats.2)
  
xtable(instru.stats.2
, caption = "Number of elements by language and authoritative designation."
, label = "tab:auths"
, digits = 0
)
```

# Demographics


```{r }
#
#
# * * D E M O G R A P H I C S  * * -------------
#
#

sexage = rbind(
  dse %>% filter(demo_item_name %in% c("Age","Sex")) %>% mutate(Condition = "Goal Models")
  ,
  dse.c %>% filter(demo_item_name %in% c("Age","Sex")) %>% mutate(Condition = "Intention Models")
  ) %>% pivot_wider(id_cols = c(participant,Condition), names_from = demo_item_name,values_from = demo_item_label) %>% 
  group_by(Condition, Sex) %>% summarise(`Average Age` = mean(as.numeric(Age)), Count = n())

kable(sexage)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.1. demoTable.tex"))
  print(xtable(sexage
         , caption = "Participants Counts and Ages by Condition and Sex."
         , label = "tab:pilot.dems"
         , digits = 0
  ))
  sink(file = NULL)
}

```


# Accuracy {.tabset}

## Preliminary - General Stats

```{r }
#
# * A C C U R A C Y ---------------
#
# Combine the languages
df1 = rbind(ds1,ds1.c)

observations = df1 %>% select(participant, item, item_full, language, type, psy_option, response) %>%
  rename("option" = psy_option,"class" = type)
authoritative = df1 %>% select(item, language, auth) %>% distinct()

acc.pc.out = accuracy.per.concept(observations, authoritative)
acc.data = acc.pc.out$acc.data
acc.pc = acc.pc.out$acc.per.concept
acc.overall = acc.pc.out$acc.per.language %>% mutate(language = lang_names[language])


# acc.data = df1 %>% 
#     mutate(authoritative = ifelse((psy_option == auth),1,0),
#            acc = ifelse((response == 1) & (authoritative == 1),1,0),
#            def = ifelse((response == 0) & (authoritative == 1),1,0),
#            exc = ifelse((response == 1) & (authoritative == 0),1,0),
#     ) %>%
#     filter((response != 0) | (authoritative != 0), psy_option != "None")  %>%
#    mutate(Language = ifelse(language == "gme","Intention Models", "Goal Models" )) %>%
#   rename("Concept" = psy_option, "Type" = type) %>%
#   select(participant, Language, Type, Concept, response, authoritative, acc,def,exc)
 
# # Per concept results
# (acc.pc = acc.data  %>% 
#     group_by(Language,Type,Concept) %>%
#     summarise(muac = mean(acc),
#               muex = mean(exc),
#               mude = mean(def),
#               ac = sum(acc),
#               ex = sum(exc),
#               def = sum(def),
#               prec = muac/(muac+muex)*100,
#               rec = muac/(muac+mude)*100) %>% ungroup()
# )
# #


# Per languge results
# (acc.overall = acc.data  %>% 
#     group_by(Language) %>%
#     summarise(muac = mean(acc),
#               muex = mean(exc),
#               mude = mean(def),
#               ac = sum(acc),
#               ex = sum(exc),
#               def = sum(def),
#               pre = muac/(muac+muex)*100,
#               rec = muac/(muac+mude)*100)
# )

kable(acc.pc %>% mutate(language = lang_names[language]))

kable(acc.overall %>% select(language, precision, recall) %>% rename_with(str_to_title))

print(xtable(acc.overall %>% select(language, precision, recall) %>% rename_with(str_to_title),
       caption = "Overal accuracy measures (%).",
       label = "tab:pilot.acc.overal"),include.rownames=FALSE)


if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. Acc-gmo-pre.tex"))
  cat(paste0(round(acc.overall %>% filter(language == "Goal Models") %>% pull(precision),1),"\\%"))
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.0.2. Acc-gmo-rec.tex"))
  cat(paste0(round(acc.overall %>% filter(language == "Goal Models") %>% pull(recall),1),"\\%"))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. Acc-gme-pre.tex"))
  cat(paste0(round(acc.overall %>% filter(language == "Intention Models") %>% pull(precision),1),"\\%"))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. Acc-gme-rec.tex"))
  cat(paste0(round(acc.overall %>% filter(language == "Intention Models") %>% pull(recall),1),"\\%"))
  sink(file = NULL)
}
```





## Hypotheses A.1 and A.7 (qualitative)

```{r}
   #          #           #      #        ####### 
  # #        ##          #      # #       #    #  
 #   #      # #         #      #   #          #   
#     #       #        #      #     #        #    
####### ###   #       #       ####### ###   #     
#     # ###   #      #        #     # ###   #     
#     # ### #####   #         #     # ###   #     


set.seed(123)
accuracy.ents = accuracyBoot(acc.data,
                        conceptStruct = list(gmo = lang$gmo$concepts,
                                             gme = lang$gme$concepts)) %>% 
  mutate (Language = lang_names[Language])
accuracy.rels = accuracyBoot(acc.data,
                        conceptStruct = list(gmo = lang$gmo$relationships,
                                             gme = lang$gme$relationships))%>% 
  mutate (Language = lang_names[Language])

# 
# acc.conc.c = accuracyBoot(acc.data %>% filter(Language == "Intention Models"),
#                         lang$gme$concepts)
# acc.rels = accuracyBoot(acc.data %>% filter(Language == "Goal Models"),
#                         lang$gmo$relationships)
# acc.rels.c = accuracyBoot(acc.data %>% filter(Language == "Intention Models"),
#                         lang$gme$relationships)
# 
# accuracy.conc  = rbind(acc.conc %>% mutate (Language = "Goal Models"),acc.conc.c  %>% mutate (Language = "Intention Models"))
# accuracy.rels  = rbind(acc.rels %>% mutate (Language = "Goal Models"),acc.rels.c  %>% mutate (Language = "Intention Models"))

kable(accuracy.ents %>% select(Language, Concept, Recall, Precision))
kable(accuracy.rels %>% select(Language, Concept, Recall, Precision))

areYouSure = FALSE
if (printTEXData & areYouSure) {
  sink(file = paste0(paperPath,"7.0.2. Acc-demoTable-ent.tex"))
  print(xtable(accuracy.conc %>% select(Language, Concept, Recall, Precision),
       caption = "Accuracy measures for entities (\\%). In brackets the 2.5th and 97.5th percentiles of 
       the bootstrapping distribution created by re-sampling with replacement the authoritative and 
       response sets 1000 times and recalculating the measures.",
       label = "tab:pilot.acc.concept"))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. Acc-demoTable-rel.tex"))
  print(xtable(accuracy.rels %>% select(Language, Concept, Recall,Precision),
       caption = "Accuracy measures for relationships (\\%). In brackets the 2.5th and 97.5th percentiles of 
       the bootstrapping distribution created by re-sampling with replacement the authoritative and 
       response sets 1000 times and recalculating the measures.",
       label = "tab:pilot.acc.relationship"
  ))
  sink(file = NULL)
}

euler.Ent = grid.arrange(print_Euler(acc.pc,"gmo","Actor"),
                         print_Euler(acc.pc,"gmo","Goal"),
                         print_Euler(acc.pc,"gmo","Belief"),
                         print_Euler(acc.pc,"gme","Organization"),
                         print_Euler(acc.pc,"gme","Goal"),
                         print_Euler(acc.pc,"gme","Objective"),ncol = 3)

euler.Rel = grid.arrange(
               print_Euler(acc.pc, "gmo","wants-to"),
               print_Euler(acc.pc, "gmo","believes-that"),
               print_Euler(acc.pc, "gmo","is-a-means-to"),
               print_Euler(acc.pc, "gmo","motivates"),
               print_Euler(acc.pc, "gme","wants-to"),
               print_Euler(acc.pc, "gme","intends-to"),
               print_Euler(acc.pc, "gme","is-a-means-to"),
               print_Euler(acc.pc, "gme","prevents"),ncol = 4)
#              print_Euler(acc.pc,"believes-that"),
#              print_Euler(acc.pc %>% filter(Language == "Goal Models"),"is-a-means-to"),
#              print_Euler(acc.pc,"motivates"),
#              print_Euler(acc.pc  %>% filter(Language == "Intention Models"),"wants-to"),
#              print_Euler(acc.pc,"intends-to"),
#              print_Euler(acc.pc  %>% filter(Language == "Intention Models"),"is-a-means-to"),
#              print_Euler(acc.pc,"prevents"),
#              ncol = 4)


             # print_Euler(acc.pc %>% filter(Language == "Goal Models"),"Goal"),
             # print_Euler(acc.pc,"Belief"),
             # print_Euler(acc.pc,"Organization"),
             # print_Euler(acc.pc %>% filter(Language == "Intention Models") ,"Goal"),
             # print_Euler(acc.pc,"Objective"),ncol = 3)
# euler.Rel = grid.arrange(
#               print_Euler(acc.pc  %>% filter(Language == "Goal Models"),"wants-to"),
#              print_Euler(acc.pc,"believes-that"),
#              print_Euler(acc.pc %>% filter(Language == "Goal Models"),"is-a-means-to"),
#              print_Euler(acc.pc,"motivates"),
#              print_Euler(acc.pc  %>% filter(Language == "Intention Models"),"wants-to"),
#              print_Euler(acc.pc,"intends-to"),
#              print_Euler(acc.pc  %>% filter(Language == "Intention Models"),"is-a-means-to"),
#              print_Euler(acc.pc,"prevents"),
#              ncol = 4)

if (printIMGData){
  ggsave(plot = euler.Ent , paste0(paperPath,"7.1.Fig-acc.ent.pdf"), width = 350, height = 180, units = "mm")
  ggsave(plot = euler.Rel , paste0(paperPath,"7.1.Fig-acc.rel.pdf"), width = 350, height = 180, units = "mm")
}
```

## Statistical Tests (A.2)

```{r}
   #         #####  
  # #       #     # 
 #   #            # 
#     #      #####  
####### ### #       
#     # ### #       
#     # ### #######


# General Test -----------------

#acc.pp = get_acc_pp(acc.data)

acc.pp = accuracy.per.participant(acc.data) %>% rename(Language = language,
                                                       Precision = precision_pp,
                                                       Recall = recall_pp)

grid.arrange(ggplot(acc.pp, aes(y = acc_pp, x = Language)) + geom_boxplot(),
             ggplot(acc.pp, aes(y = Precision, x = Language)) + geom_boxplot(),
             ggplot(acc.pp, aes(y = Recall, x = Language)) + geom_boxplot())

# Wilcoxon rank-sum test
pre_Language = wilcox.test(data = acc.pp, Precision ~ Language,exact = FALSE)
rec_Language = wilcox.test(data = acc.pp, Recall ~ Language,exact = FALSE)


if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. Acc-A2-pre.tex"))
  cat(reportWilcox(pre_Language,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. Acc-A2-rec.tex"))
  cat(reportWilcox(rec_Language,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}
```



## Statistical Tests (A.3)

```{r}
   #         #####  
  # #       #     # 
 #   #            # 
#     #      #####  
####### ###       # 
#     # ### #     # 
#     # ###  ##### 

# Example individual comparison: Actor vs. Organization -----------------
#acc.pp.a3 = get_acc_pp(acc.data,concepts = c("Actor","Organization"))
# acc.pp.a3.early = acc.pp.a3

acc.pp.a3 = acc.pp %>% filter(concept %in% c("Actor","Organization")) %>% mutate(Language = lang_names[Language])

grid.arrange(ggplot(acc.pp.a3, aes(y = Recall, x = Language)) + geom_boxplot(),
             ggplot(acc.pp.a3, aes(y = Precision, x = Language)) + geom_boxplot(),
             nrow = 3)

# Wilcoxon rank-sum test
acc.pp.a3.result = wilcox.test(data = acc.pp.a3, Recall ~ Language,exact = FALSE)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a3.result.tex"))
  cat(reportWilcox(acc.pp.a3.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}
```

## Statistical Tests (A.4)

```{r}
   #        #       
  # #       #    #  
 #   #      #    #  
#     #     #    #  
####### ### ####### 
#     # ###      #  
#     # ###      #  

# Example individual comparison: Belief vs. Objective -----------------
# acc.pp.a4 = get_acc_pp(acc.data,concepts = c("Belief","Objective"))
# acc.pp.a4.early = acc.pp.a4

acc.pp.a4 = acc.pp %>% filter(concept %in% c("Belief","Objective")) %>% mutate(Language = lang_names[Language])

grid.arrange(ggplot(acc.pp.a4, aes(y = Recall, x = Language)) + geom_boxplot(),
             ggplot(acc.pp.a4, aes(y = Precision, x = Language)) + geom_boxplot(),
             nrow = 2)

# Wilcoxon rank-sum test
acc.pp.a4.pre.result = wilcox.test(data = acc.pp.a4, Precision ~ Language,exact = FALSE)
acc.pp.a4.rec.result = wilcox.test(data = acc.pp.a4, Recall ~ Language,exact = FALSE)


if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a4.pre.result.tex"))
  cat(reportWilcox(acc.pp.a4.pre.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a4.rec.result.tex"))
  cat(reportWilcox(acc.pp.a4.rec.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}
```


## Statistical Tests (A.5)
```{r}
   #        ####### 
  # #       #       
 #   #      #       
#     #     ######  
####### ###       # 
#     # ### #     # 
#     # ###  ##### 

# Example individual comparison: believes-that vs. intends-to -----------------
#acc.pp.a5 = get_acc_pp(acc.data,concepts = c("believes-that","intends-to"))
#acc.pp.a5.early = acc.pp.a5

acc.pp.a5 = acc.pp %>% filter(concept %in% c("believes-that","intends-to")) %>% mutate(Language = lang_names[Language])

grid.arrange(ggplot(acc.pp.a5, aes(y = Recall, x = Language)) + geom_boxplot(),
             ggplot(acc.pp.a5, aes(y = Precision, x = Language)) + geom_boxplot(),
             nrow = 2)

# Wilcoxon rank-sum test
acc.pp.a5.pre.result = wilcox.test(data = acc.pp.a5, Precision ~ Language,exact = FALSE)
acc.pp.a5.rec.result = wilcox.test(data = acc.pp.a5, Recall ~ Language,exact = FALSE)


if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a5.pre.result.tex"))
  cat(reportWilcox(acc.pp.a5.pre.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a5.rec.result.tex"))
  cat(reportWilcox(acc.pp.a5.rec.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}
```

## Statistical Tests (A.6)
```{R}
   #         #####  
  # #       #     # 
 #   #      #       
#     #     ######  
####### ### #     # 
#     # ### #     # 
#     # ###  #####  

# Example individual comparison: motivates vs. prevents -----------------
#acc.pp.a6 = get_acc_pp(acc.data,concepts = c("prevents","motivates"))
#acc.pp.a6.e = acc.pp.a6

acc.pp.a6 = acc.pp %>% filter(concept %in% c("prevents","motivates")) %>% mutate(Language = lang_names[Language])


grid.arrange(ggplot(acc.pp.a6, aes(y = Recall, x = Language)) + geom_boxplot(),
             ggplot(acc.pp.a6, aes(y = Precision, x = Language)) + geom_boxplot(),
             nrow = 2)

# Wilcoxon rank-sum test
acc.pp.a6.rec.result = wilcox.test(data = acc.pp.a6, Recall ~ Language,exact = FALSE)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a6.rec.result.tex"))
  cat(reportWilcox(acc.pp.a6.rec.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}
```




## Statistical Tests (A.7)
```{R}
    #        ####### 
   # #       #    #  
  #   #          #   
 #     #        #    
 ####### ###   #     
 #     # ###   #     
 #     # ###   #   



# Example individual comparison: is-a-means-to vs. prevents -----------------
# acc.pp.a7 = get_acc_pp(acc.data,concepts = c("is-a-means-to"))
# acc.pp.a7e = acc.pp.a7

acc.pp.a7 = acc.pp %>% filter(concept %in% c("is-a-means-to")) %>% mutate(Language = lang_names[Language])


grid.arrange(ggplot(acc.pp.a7, aes(y = Recall, x = Language)) + geom_boxplot(),
             ggplot(acc.pp.a7, aes(y = Precision, x = Language)) + geom_boxplot(),
             nrow = 2)

# Wilcoxon rank-sum test
acc.pp.a7.pre.result = wilcox.test(data = acc.pp.a7, Precision ~ Language,exact = FALSE)
acc.pp.a7.rec.result = wilcox.test(data = acc.pp.a7, Recall ~ Language,exact = FALSE)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a7.pre.result.tex"))
  cat(reportWilcox(acc.pp.a7.pre.result,alpha =expAlphaLevel/(accExps)))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.0.2. acc.pp.a7.rec.result.tex"))
  cat(reportWilcox(acc.pp.a7.rec.result,alpha = expAlphaLevel/(accExps)))
  sink(file = NULL)
}

# Are precisions equivalent? (fat chance)
tsum_TOST(
  m1 = mean(acc.pp.a7 %>% filter(Language == "Goal Models") %>% pull(Precision)),
  m2 = mean(acc.pp.a7 %>% filter(Language == "Intention Models") %>% pull(Precision)),
  sd1 = sd(acc.pp.a7 %>% filter(Language == "Goal Models") %>% pull(Precision)),
  sd2 = sd(acc.pp.a7 %>% filter(Language == "Intention Models") %>% pull(Precision)),
  n1 = length(acc.pp.a7 %>% filter(Language == "Goal Models") %>% pull(Precision)),
  n2 = length(acc.pp.a7 %>% filter(Language == "Intention Models") %>% pull(Precision)),
  low_eqbound = -1.0,
  high_eqbound = +1.0,
  eqbound_type = "SMD",
  alpha = expAlphaLevel,
  var.equal = F
  )
```

















# Deficit {.tabset}

## Descriptives per item (D.1)
```{R}
######        #   
#     #      ##   
#     #     # #   
#     #       #   
#     # ###   #   
#     # ###   #   
######  ### ##### 


#
#  Descriptives per item ---------------
#

def.outcome = deficit(observations)
def.item = def.outcome$def.item
def.tab = def.outcome$def.tab

#def.iteme = def.item
# def.item = 
#   df1 %>% mutate(resp_na = ifelse((psy_option == "None") & (response == 1),1,0)) %>%
#   group_by(language,type,item) %>% summarise (nas = sum(resp_na)) %>% 
#   inner_join(df1 %>% group_by(language,type,item,psy_item) %>% summarise (totals_ = n()) %>%
#                group_by(language,type,item) %>% summarise (totals = max(totals_)),
#              by = c("language"="language","type"="type","item"="item")) %>%
#   mutate(Deficit = nas/totals)
# 
# def.tabe = def.tab
# # Descriptive per item
# 
# def.tab = def.item %>% group_by(language,type) %>% summarise(max = max(Deficit),
#                             q95 = quantile(Deficit, 0.95),
#                             q90 = quantile(Deficit, 0.90),
#                             q75 = quantile(Deficit, 0.75)) %>% 
#     mutate(Language = ifelse(language == "gmo","Goal Models", "Intention Models"),
#            Type = ifelse(type == "concept","Concepts", "Relationships")) %>%
#     ungroup() %>% select(Language,Type,max,q95,q90,q75) %>% arrange(Language,Type)

# Goal Models: Entities
def.graph.conc = ggplot(data = def.item %>% filter(language == "gmo", class == "concept"),
  aes(x = Deficit)) + geom_histogram(bins = 9,boundary = 0) + bigthema +
geom_density(alpha=.2, fill="#66FF66") + xlim(c(0,1)) + ggtitle("Goal Models: Entities")
#

# Goal Models: Relationships
def.graph.rel = ggplot(data = def.item %>% filter(language == "gmo", class == "relationship"),
                       aes(x = Deficit)) + geom_histogram(bins = 9,boundary = 0) + bigthema +
  geom_density(alpha=.2, fill="#66FF66") + xlim(c(0,1)) + ggtitle("Goal Models: Relationships")
#

# Intention Models: Entities
def.graph.conc.c = ggplot(data = def.item %>% filter(language == "gme", class == "concept"),
                       aes(x = Deficit)) + geom_histogram(bins = 9,boundary = 0) + bigthema +
  geom_density(alpha=.2, fill="#FF6666") + xlim(c(0,1)) + ggtitle("Intention Models: Entities")
#

# Intention Models: Relationships
def.graph.rel.c = ggplot(data = def.item %>% filter(language == "gme", class == "relationship"),
                      aes(x = Deficit)) + geom_histogram(bins = 9,boundary = 0) + bigthema +
  geom_density(alpha=.2, fill="#FF6666") + xlim(c(0,1))  + ggtitle("Intention Models: Relationships")
#

def.hists = grid.arrange(def.graph.conc,def.graph.rel,def.graph.conc.c,def.graph.rel.c)

if (printIMGData){
  ggsave(plot = def.hists, paste0(paperPath,"7.2.Fig-def.hist.pdf"), width = 350, height = 180, units = "mm")
}

def.tab.prez = def.tab %>% mutate(
  Language = lang_names[language],
  Class = ifelse(type == "concept","Concepts", "Relationships")) %>%
     ungroup() %>% select(Language,Class,max,q95,q90,q75) %>% arrange(Language,Class)

kable(def.tab.prez)

areYouSure = FALSE
if (printTEXData & areYouSure){
  sink(file =  paste0(paperPath,"7.2. Def-deftable.tex"), append = FALSE)
  print(xtable(def.tab.prez,caption = "Deficit measures: maximum observed, and 95th, 90th and 75th quantile.",label = "tab:def"),
      include.rownames = F)
  sink(file = NULL)
}

head(def.item %>% ungroup() %>% filter(class == "concept",language == "gmo") %>% select(item_full,Deficit) %>% arrange(-Deficit))
head(def.item %>% ungroup() %>% filter(class == "concept",language == "gme") %>% select(item_full,Deficit) %>% arrange(-Deficit))

# #Drill down
# def.drill = ds1 %>% filter(type == "concept") %>% 
#   filter(psy_option == "None") %>% 
#   group_by(item,item_full) %>%
#   summarise (Incompleteness = mean(response)) %>% arrange(-Incompleteness)
# 
# head(def.drill %>% ungroup %>% select(item_full,Incompleteness))
# 
# def.drill.c = ds1.c %>% filter(type == "concept") %>% 
#   filter(psy_option == "None") %>% 
#   group_by(item,item_full) %>%
#   summarise (Incompleteness = mean(response)) %>% arrange(-Incompleteness)
# 
# head(def.drill.c %>% ungroup %>% select(item_full,Incompleteness))
```


## Inferential per participant (D.2)

```{R}
######       #####  
#     #     #     # 
#     #           # 
#     #      #####  
#     # ### #       
#     # ### #       
######  ### #######

# Inferential per participant --------------------
# def.partie = def.parti
# 
# def.parti = 
#   df1 %>% mutate(resp_na = ifelse((psy_option == "None") & (response == 1),1,0)) %>%
#   group_by(language,type,participant) %>% summarise (nas = sum(resp_na)) %>% 
#   inner_join(df1 %>% group_by(language,type,participant) %>% summarise (totals = sum(psy_option == "None"))) %>%
#   mutate(Deficit = nas/totals,
#          Language = ifelse(language == "gmo","Goal Models", "Intention Models"),
#          Type = ifelse(type == "concept","Concepts", "Relationships")) %>% ungroup() %>%
#   select(Language, Type, participant, Deficit)
#

# Visual
ggplot(def.parti, aes(y = Deficit)) + geom_boxplot() + facet_grid(class ~ language)

# Wilcoxon tests
## Entities
def.ent.res = wilcox.test(data = def.parti %>% filter(class == "concept"), Deficit ~ language,exact = FALSE)

## Relationships
def.rel.res = wilcox.test(data = def.parti %>% filter(class == "relationship"), Deficit ~ language,exact = FALSE)

# Effect size: difference between means
def.parti.effect = def.parti %>% group_by(language,class) %>% summarise(Deficit = mean(Deficit))

def.ent.size = round(abs(def.parti.effect %>% 
      filter(language == "gmo", class == "concept") %>% pull(Deficit) - 
      def.parti.effect %>% 
      filter(language == "gme", class == "concept") %>% pull(Deficit)),3)
def.rel.size = round(abs(def.parti.effect %>% 
      filter(language == "gmo", class == "relationship") %>% pull(Deficit) - 
      def.parti.effect %>% 
      filter(language == "gme", class == "relationship") %>% pull(Deficit)),3)
cat("Entities effect size:", def.ent.size, "\n")
cat("Relationships effect size:", def.rel.size, "\n")
#

if (printTEXData) {
  sink(file = paste0(paperPath,"7.2. def.ent.res.tex"))
  cat(reportWilcox(def.ent.res,alpha = expAlphaLevel/(defExps)))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.2. def.rel.res.tex"))
  cat(reportWilcox(def.rel.res,alpha = expAlphaLevel/(defExps)))
  sink(file = NULL)
  
  
  sink(file = paste0(paperPath,"7.2. def.ent.size.tex"))
  cat(def.ent.size)
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.2. def.rel.size.tex"))
  cat(def.rel.size)
  sink(file = NULL)
}

```

## Relationship to self-reported (S.1)
```{r }
 #####        #   
#     #      ##   
#           # #   
 #####        #   
      # ###   #   
#     # ###   #   
 #####  ### ##### 


# Comparison with Self-Reported ----------------------------
self.conc.compl = ds2 %>% filter(psy_item == "conceptCompleteness:1") %>% 
  inner_join(def.parti %>% filter(class == "concept")) %>% select(participant,value,Deficit)
self.rels.compl = ds2 %>% filter(psy_item == "relationshipCompleteness:1") %>% 
  inner_join(def.parti %>% filter(class == "relationship")) %>% select(participant,value,Deficit)

self.conc.compl.c = ds2.c %>% filter(psy_item == "conceptCompleteness:1") %>% 
  inner_join(def.parti %>% filter(class == "concept")) %>% select(participant, value,Deficit)
self.rels.compl.c = ds2.c %>% filter(psy_item == "relationshipCompleteness:1") %>% 
  inner_join(def.parti %>% filter(class == "relationship")) %>% select(participant,value,Deficit)

self.compl.all = rbind(self.conc.compl,
    self.conc.compl.c,
    self.rels.compl,
    self.rels.compl.c
)

def.self.corr = cor.test(self.compl.all[-c(4),"value"]$value,
         self.compl.all[-c(4),"Deficit"]$Deficit,
         method = "kendall",exact = FALSE)


if (printTEXData) {
  sink(file = paste0(paperPath,"7.3. def.self.corr.tex"))
  cat(reportKendalCor(def.self.corr,alpha = expAlphaLevel/(selfExps)))
  sink(file = NULL)
}

def.self.corr.plot = ggplot(self.compl.all,aes(x=value, y = Deficit)) + 
  geom_point() + geom_smooth(method='lm', formula= y~x) +
  xlab("Self-Reported Completeness") + ylab("Observed Deficit") + bigthema
  

if (printIMGData) {
   ggsave(plot = def.self.corr.plot, paste0(paperPath,"7.3.Fig-self.def.pdf"), 
          width = 350, height = 180, units = "mm")
}
``` 




# Excess {.tabset}

## Hypothesis E.1.

```{r }
#######       #         #   
#            ##        ##   
#           # #       # #   
#####         #         #   
#       ###   #   ###   #   
#       ###   #   ###   #   
####### ### ##### ### ##### 

exc.outcome = excess(observations)
exc.data = exc.outcome$exc.data
exc.descr = exc.outcome$exc.descr
exc.outcome$exc.per.participant
# # gmo -------------------------
# 
# # Descriptive
# # gmo -------------------------
# parts = length(unique(ds1 %>% pull(participant)))
# exc.list = ds1 %>% filter(psy_option != "None") %>% 
#   select(participant, item, response, psy_option) %>%
#   group_by(item,psy_option) %>% 
#   summarise(score = sum(response)) %>%  ungroup() %>%
#   group_by(psy_option) %>% 
#   summarise(max_r = max(score)) %>%
#   mutate (exc = 1 - max_r/parts) %>% select(psy_option, exc) %>% arrange(-exc)
# 
# # gme -------------------------
# parts.c = length(unique(ds1.c %>% pull(participant)))
# exc.list.c = ds1.c %>% filter(psy_option != "None") %>% 
#   select(participant, item, response, psy_option) %>%
#   group_by(item,psy_option) %>% 
#   summarise(score = sum(response)) %>%  ungroup() %>%
#   group_by(psy_option) %>% 
#   summarise(max_r = max(score)) %>%
#   mutate (exc = 1 - max_r/parts.c) %>% select(psy_option, exc) %>% arrange(-exc)
# 
# reason.for.organization.excess = ds1.c %>% 
#   select(participant, item, response, psy_option,item_full) %>%
#   group_by(item,psy_option,item_full) %>% 
#   summarise(score = sum(response)) %>% filter(item == "descr2_item10_concepts")

reason.for.organization.excess = exc.data %>% filter(item == "descr2_item10_concepts") %>% inner_join(observations %>% distinct(item,item_full)) %>% select(-class,-item)
# i.e., the one and only true organization in the data set still has some detractors.


# exc.list.c.whatif = ds1.c %>% filter(psy_option != "None") %>% 
#   filter(item != "descr2_item10_concepts") %>%
#   select(participant, item, response, psy_option) %>%
#   group_by(item,psy_option) %>% 
#   summarise(score = sum(response)) %>%  ungroup() %>%
#   group_by(psy_option) %>% 
#   summarise(max_r = max(score)) %>%
#   mutate (exc = 1 - max_r/parts.c) %>% select(psy_option, exc) %>% arrange(-exc)


#######       #        #####  
#            ##       #     # 
#           # #             # 
#####         #        #####  
#       ###   #   ### #       
#       ###   #   ### #       
####### ### ##### ### ####### 


# Inferential per participant --------------
# exc.comb <- df1 %>% filter(psy_option != "None") %>% 
#   group_by(language,participant,psy_option,type) %>% 
#   summarise(prevalence = sum(response)/n()) %>%
#   mutate(Language = ifelse(language == "gmo","Goal Models","Intention Models"),
#          Concept = factor(psy_option,
#                           levels = c("Actor","Organization","Goal",
#                                      "Belief","Objective",
#                                      "wants-to","intends-to","believes-that",
#                                      "prevents","motivates","is-a-means-to")))

exc.pp = exc.outcome$exc.per.participant

ggplot(exc.pp,aes(x = option, y = exc_V_pp, fill = language)) + geom_boxplot() + 
  facet_wrap(~language, scales="free_x")

#exc.rese = exc.res
exc.res = wilcox.test(data = exc.pp %>%
              select(participant,language,exc_V_pp) %>% 
              group_by(participant,language) %>% 
              summarise(exc_V_pp = mean(exc_V_pp)),
            exc_V_pp ~ language,exact = FALSE,alternative = "greater")

if (printTEXData) {
  sink(file = paste0(paperPath,"7.2. exc.res.tex"))
  cat(reportWilcox(exc.res,alpha = expAlphaLevel/excExps))
  sink(file = NULL)
}
```

## Hypotheses E.2 - E.4

```{r }
#######      #####              #######     #       
#           #     #             #           #    #  
#                 #             #           #    #  
#####        #####     #####    #####       #    #  
#       ### #                   #       ### ####### 
#       ### #                   #       ###      #  
####### ### #######             ####### ###      #  
# exs.wilx_ = c(
#   act.org = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("Actor","Organization")) %>%
#                            select(psy_option,prevalence),prevalence ~ psy_option,
#               exact = FALSE,alternative = "greater")$p.value,
#   bel.obj = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("Belief","Objective")) %>%
#                            select(psy_option,prevalence), prevalence ~ psy_option,
#               exact = FALSE,alternative = "less")$p.value,
#   goal.goal = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("Goal")) %>%
#                            select(psy_option,Language,prevalence), prevalence ~ Language,
#               exact = FALSE,alternative = "greater")$p.value,
#   want.want = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("wants-to")) %>%
#                            select(psy_option,Language,prevalence),prevalence ~ Language,
#               exact = FALSE,alternative = "less")$p.value,
#   bel.int = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("believes-that","intends-to")) %>%
#                            select(psy_option,prevalence),prevalence ~ psy_option,
#               exact = FALSE,alternative = "less")$p.value,
#   mot.prev = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("motivates","prevents")) %>%
#                            select(psy_option,prevalence),prevalence ~ psy_option,
#               exact = FALSE,alternative = "greater")$p.value,
#   means.means = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("is-a-means-to")) %>%
#                            select(psy_option,Language,prevalence),prevalence ~ Language,
#               exact = FALSE,alternative = "less")$p.value)
# exc.list$order = c(6, 1, 2, 5, 3, 7, 4)
# exc.list.c$order = c(6, 3, 5, 1, 4, 2, 7)



exs.wilx_ = c(
  act.org = wilcox.test(data = exc.pp %>% filter(option %in% c("Actor","Organization")) %>%
                           select(option,exc_V_pp),exc_V_pp ~ option,
              exact = FALSE,alternative = "two.sided")$p.value,
  bel.obj = wilcox.test(data = exc.pp %>% filter(option %in% c("Belief","Objective")) %>%
                           select(option,exc_V_pp), exc_V_pp ~ option,
              exact = FALSE,alternative = "two.sided")$p.value,
  goal.goal = wilcox.test(data = exc.pp %>% filter(option %in% c("Goal")) %>%
                           select(option,language,exc_V_pp), exc_V_pp ~ language,
              exact = FALSE,alternative = "two.sided")$p.value,
  want.want = wilcox.test(data = exc.pp %>% filter(option %in% c("wants-to")) %>%
                           select(option,language,exc_V_pp),exc_V_pp ~ language,
              exact = FALSE,alternative = "two.sided")$p.value,
  bel.int = wilcox.test(data = exc.pp %>% filter(option %in% c("believes-that","intends-to")) %>%
                           select(option,exc_V_pp),exc_V_pp ~ option,
              exact = FALSE,alternative = "two.sided")$p.value,
  mot.prev = wilcox.test(data = exc.pp %>% filter(option %in% c("motivates","prevents")) %>%
                           select(option,exc_V_pp),exc_V_pp ~ option,
              exact = FALSE,alternative = "two.sided")$p.value,
  means.means = wilcox.test(data = exc.pp %>% filter(option %in% c("is-a-means-to")) %>%
                           select(option,language,exc_V_pp),exc_V_pp ~ language,
              exact = FALSE,alternative = "two.sided")$p.value
  )

ifelse(exs.wilx_ <= expAlphaLevel/(defExps*7), paste0(round(exs.wilx_,3),"*"),round(exs.wilx_,3))
#

exc.descr.gmo = exc.descr %>% filter(language == "gmo")
exc.descr.gme = exc.descr %>% filter(language == "gme")
exc.descr.gmo$option = ordered(exc.descr.gmo$option,levels = c(lang$gmo$concepts,lang$gmo$relationships))
exc.descr.gme$option = ordered(exc.descr.gme$option,levels = c(lang$gme$concepts,lang$gme$relationships))

exc.per.concept = cbind(exc.descr.gmo %>% rename("Concept1" = option, "Excess1"= exc_v_max) %>% ungroup() %>%
                    select(Concept1,Excess1) %>% arrange(Concept1),
                  exc.descr.gme %>% rename("Concept2" = option, "Excess2"= exc_v_max) %>% ungroup() %>%
                    select(Concept2,Excess2)  %>% arrange(Concept2),
             pval = exs.wilx)
rownames(exc.per.concept) = NULL
kable(exc.per.concept)


# 
# exc.pc = cbind(exc.outcome$exc.descr %>% rename("Concepts1" = psy_option, "Excess1"= exc) %>% 
#                arrange(order) %>% select(-order),
#              exc.list.c %>% rename("Concepts2" = psy_option, "Excess2"= exc)%>% 
#                arrange(order) %>% select(-order),
#              pval = exs.wilx)


areYouSure = FALSE
if (printTEXData & areYouSure) {
  sink(file = paste0(paperPath,"7.2. exc.list.tex"))
  print(xtable(exc.per.concept,
               caption = paste0("Excess per concept. (*) = significant at $ p=", round(paperAlphaLevel,4), "/7 = ",round(paperAlphaLevel/7,5),"$ after Bonferroni correction for the 7 comparisons"),
               label = "exc.list",
               digits = 3))
  sink(file = NULL)
}

# exc.prevents = wilcox.test(data = exc.comb %>% filter(psy_option %in% c("motivates","prevents")) %>% select(psy_option,prevalence),prevalence ~ psy_option, exact = FALSE,alternative = "greater")

exc.prevents = wilcox.test(data = exc.pp %>% filter(option %in% c("motivates","prevents")) %>%
                           select(option,exc_V_pp),exc_V_pp ~ option,
              exact = FALSE,alternative = "two.sided")


if (printTEXData) {
  sink(file = paste0(paperPath,"7.2. exc.prevents.tex"))
  cat(reportWilcox(exc.prevents,alpha = expAlphaLevel/excExps))
  sink(file = NULL)
}



# Confidence intervals 
result = tribble(~Concept, ~Lower, ~Mean, ~Upper)
for (concept in unique(unlist(lang,use.names = F))) {
  re = bootstrap.ci(exc.pp %>% filter(option == concept) %>% pull(exc_V_pp), 
                    conf.level=0.95, R=999)
  result = result %>% add_row(Concept = concept, 
                              Lower = re[1], Mean = re[2], Upper = re[3])
}
result = result %>% mutate(Concept = factor(Concept,
                        levels = c("Actor","Organization","Goal",
                                   "Belief","Objective",
                                   "wants-to","intends-to","believes-that",
                                   "prevents","motivates","is-a-means-to")))

ggplot(result, aes(x=Mean, y=Concept)) + 
  geom_errorbar(aes(xmin=Lower, xmax=Upper),width = .1) +
  geom_point() + scale_y_discrete(limits=rev)
```

## Relationship to self-reported (S.2)

```{r }
 #####       #####  
#     #     #     # 
#                 # 
 #####       #####  
      # ### #       
#     # ### #       
 #####  ### #######


## Comparison with Self-Reported (all data) -----------
excessCorr = ds2 %>% filter(psy_item %in% c(paste0("conceptRelevance:",c(1,2,3)),paste0("relationshipRelevance:",c(1,2,3,4)))) %>% 
  inner_join(exc.pp, by = c("participant" = "participant", "concept" = "option", "language" = "language"))

excessCorr.c = ds2.c %>% filter(psy_item %in% c(paste0("conceptRelevance:",c(1,2,3)),paste0("relationshipRelevance:",c(1,2,3,4)))) %>% 
  inner_join(exc.pp, by = c("participant" = "participant", "concept" = "option", "language" = "language"))

excessCorr.all = rbind(excessCorr, excessCorr.c) %>% rename(excess = exc_V_pp)

exc.self.corr.plot = ggplot(excessCorr.all,aes(x=value, y = excess)) + geom_point() + geom_smooth(method='lm', formula= y~x) + xlab("Self Reported Excess") + ylab("Self Reported Excess") + bigthema

if (printIMGData) {
   ggsave(plot = exc.self.corr.plot, paste0(paperPath,"7.3.Fig-self.exc.pdf"), 
          width = 350, height = 180, units = "mm")
}

excessCorr.all.corr = cor.test(
  excessCorr.all %>% pull(value),
  excessCorr.all %>% pull(excess),
  method = "kendall",exact = FALSE)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.3. Exc-self.corr.tex"))
  cat(reportKendalCor(excessCorr.all.corr,alpha = expAlphaLevel/(selfExps)))
  sink(file = NULL)
}
```







# Redundancy {.tabset}

## Qualitative Analysis (O.1, O.3)

```{r }
#######       #            #    #######      #####  
#     #      ##           #     #     #     #     # 
#     #     # #          #      #     #           # 
#     #       #         #       #     #      #####  
#     # ###   #        #        #     # ###       # 
#     # ###   #       #         #     # ### #     # 
####### ### #####    #          ####### ###  #####

# Redundancy ----------------
# gmo ------
# ds1_ratings = ds1 %>% group_by(item,psy_option,type) %>%
#   summarise(n = sum(response)) %>% 
#   rename("concept" = psy_option) %>%
#   left_join(ds1 %>% group_by(item) %>% summarise(n_s = sum(response)))

ov_ratings = observations %>% group_by(language,class,item,option) %>%
  summarise(n = sum(response)) %>% 
  rename("concept" = option) %>%
  left_join(observations %>% group_by(language,item) %>% summarise(n_s = sum(response)))


OVI.conc = overlaps.per.item(observations = observations %>% filter(class == "concept"),
                  l = "gmo",
                  #ds1_ratings %>% filter(type == "concept"),
                  lang[["gmo"]][["concepts"]],
                  overlapFunc = ov2,
                  threshold = 0.1)

# OVI.conc = overlaps.per.item(ov_ratings %>% filter(class == "concept",language == "gmo"),
#                             #ds1_ratings %>% filter(type == "concept"),
#                              lang[["gmo"]][["concepts"]],
#                              overlapFunc = ov2,
#                              threshold = 0.1)

OVI.rel = overlaps.per.item(observations = observations %>% filter(class == "relationship"),
                  l = "gmo",
                  #ds1_ratings %>% filter(type == "concept"),
                  lang[["gmo"]][["relationships"]],
                  overlapFunc = ov2,
                  threshold = 0.1)

# OVI.rel = overlaps.per.item(ov_ratings %>% filter(class == "relationship",language == "gmo") %>% arrange(desc(language)),
#                             lang[["gmo"]][["relationships"]],
#                             overlapFunc = ov2,
#                             threshold = 0.1)

OVI.conc.c = overlaps.per.item(observations = observations %>% filter(class == "concept"),
                  l = "gme",
                  #ds1_ratings %>% filter(type == "concept"),
                  lang[["gme"]][["concepts"]],
                  overlapFunc = ov2,
                  threshold = 0.1)

# OVI.conc.c = overlaps.per.item(ov_ratings %>% filter(class == "concept",language == "gme") %>% arrange(desc(language)),
#                                lang[["gme"]][["concepts"]],
#                                overlapFunc = ov2,
#                                threshold = 0.1)

OVI.rel.c = overlaps.per.item(observations = observations %>% filter(class == "relationship"),
                  l = "gme",
                  #ds1_ratings %>% filter(type == "concept"),
                  lang[["gme"]][["relationships"]],
                  overlapFunc = ov2,
                  threshold = 0.1)

# OVI.rel.c = overlaps.per.item(ov_ratings %>% filter(class == "relationship",language == "gme") %>% arrange(desc(language)),
#                               lang[["gme"]][["relationships"]],
#                               overlapFunc = ov2,
#                               threshold = 0.1)

why.goal.belief = OVI.conc$data %>% filter((concept1 == "Goal") & (concept2 == "Belief") | (concept2 == "Goal") & (concept1 == "Belief")) %>% arrange(-overlap) %>% inner_join(ds1 %>% select(item,item_full) %>% group_by(item) %>% summarise(item_full = first(item_full))) 
# 
# 
# # gme ------
# ds1c_ratings = ds1.c %>% group_by(item,psy_option,type) %>% 
#   summarise(n = sum(response)) %>% 
#   rename("concept" = psy_option) %>%
#   left_join(ds1.c %>% group_by(item) %>% summarise(n_s = sum(response))) 


# red.tab = rbind(
#   OVI.conc$stats %>% select(concept1,concept2,median,q25,q10,min),
#   OVI.rel$stats %>% select(concept1,concept2,median,q25,q10,min), 
#   OVI.conc.c$stats %>% select(concept1,concept2,median,q25,q10,min),
#   OVI.rel.c$stats %>% select(concept1,concept2,median,q25,q10,min) 
# )

red.tab = rbind(
  redundancy(OVI.conc$stats) %>% mutate(Language = "Goal Models"),
  redundancy(OVI.rel$stats) %>% mutate(Language = "Goal Models"),
  redundancy(OVI.conc.c$stats) %>% mutate(Language = "Intention Models"),
  redundancy(OVI.rel.c$stats) %>% mutate(Language = "Intention Models")
)


kable(red.tab %>% relocate(Language,.before = Concept))

exc.goal.gmo = red.tab %>% filter(Language == "Goal Models",Concept == "Goal") %>% pull(q10)
exc.goal.gme = red.tab %>% filter(Language == "Intention Models",Concept == "Goal") %>% pull(q10)
exc.objective.gme = red.tab %>% filter(Language == "Intention Models",Concept == "Objective") %>% pull(q10)
exc.wants.gme = red.tab %>% filter(Language == "Intention Models",Concept == "wants-to") %>% pull(q10)
exc.intends.gme = red.tab %>% filter(Language == "Intention Models",Concept == "intends-to") %>% pull(q10)

areYouSure = FALSE
if (printTEXData & areYouSure) {
  sink(file = paste0(paperPath,"7.3. Exc-redtable.tex"))
  print(xtable(red.tab %>% select(-Language),
       caption = "Redundancy indexes.",
       label = "tab:red"))
  sink(file = NULL)
}

if (printTEXData) {
  sink(file = paste0(paperPath,"7.3. Exc-redtable.goal.tex"))
  cat(round(exc.goal.gme,2))
  sink(file = NULL)
  
  sink(file = paste0(paperPath,"7.3. Exc-redtable.wants.tex"))
  cat(round(exc.wants.intends,2))
  sink(file = NULL)
}

# Drill-in histograms (unused) --------------
ovi.drillInHisto <- function(df,color){
  ggplot(df,aes(x = overlap)) + 
    geom_histogram(bins = 10, boundary = 0, aes(y = stat(count) / sum(count))) + 
    geom_density(alpha=.2, fill=color) + xlim(c(0,1)) + ylab("Frequency")
}

ovi.goalObjectiveOvlp = OVI.conc.c$data %>% filter(concept1 == "Goal",concept2 == "Objective") %>% select(overlap)
ovi.wantstoIntendsToOvlp = OVI.rel.c$data %>% filter(concept1 == "wants-to",concept2 == "intends-to") %>% select(overlap)
ovi.goalBeliefOvlp = OVI.conc$data %>% filter(concept1 == "Goal",concept2 == "Belief") %>% select(overlap)
ovi.wantstoBelievesthatOvlp = OVI.rel$data %>% filter(concept1 == "wants-to",concept2 == "believes-that") %>% select(overlap)

grid.arrange(
  ovi.drillInHisto(ovi.goalObjectiveOvlp,"#66FF66") + ggtitle("Goal vs. Objective"),
  ovi.drillInHisto(ovi.wantstoIntendsToOvlp,"#66FF66") + ggtitle("wants-to vs. intends-to"),
  ovi.drillInHisto(ovi.goalBeliefOvlp,"#FF6666") + ggtitle("Goal vs. Belief"),
  ovi.drillInHisto(ovi.wantstoBelievesthatOvlp,"#FF6666") + ggtitle("wants-to vs. believes-that")
)

# Tiles -------------


# ovi.tile.conc = rbind(OVI.conc$stats,
#       OVI.conc$stats %>% rename(concept1 = concept2, concept2 = concept1)) %>% 
#       mutate(concept1 = factor(concept1,levels = lang$gmo$concepts),
#              concept2 = factor(concept2,levels = lang$gmo$concepts))
# ovi.tile.rel = rbind(OVI.rel$stats,
#                       OVI.rel$stats %>% rename(concept1 = concept2, concept2 = concept1)) %>% 
#       mutate(concept1 = factor(concept1,levels = lang$gmo$relationships),
#              concept2 = factor(concept2,levels = lang$gmo$relationships))
# ovi.tile.conc.c = rbind(OVI.conc.c$stats,
#                       OVI.conc.c$stats %>% rename(concept1 = concept2, concept2 = concept1)) %>% 
#       mutate(concept1 = factor(concept1,levels = lang$gme$concepts),
#              concept2 = factor(concept2,levels = lang$gme$concepts))
# ovi.tile.rel.c = rbind(OVI.rel.c$stats,
#                      OVI.rel.c$stats %>% rename(concept1 = concept2, concept2 = concept1)) %>%
#       mutate(concept1 = factor(concept1,levels = lang$gme$relationships),
#              concept2 = factor(concept2,levels = lang$gme$relationships))

ovi.tile.obs <- grid.arrange(
  blackOvTile(OVI.conc$tile,statistic = mean, "Goal Models, Entities"),
  blackOvTile(OVI.rel$tile,statistic = mean, "Goal Models, Relationships"),
  blackOvTile(OVI.conc.c$tile,statistic = mean, "Intention Models, Entities"),
  blackOvTile(OVI.rel.c$tile,statistic = mean, "Intention Models, Relationships")) + 
  theme(plot.margin = unit(c(1,1,1,1),"cm"))

F.7.3.Fig.tile = arrangeGrob(
  blackOvTile(OVI.conc$tile,statistic = mean, "Goal Models, Entities"),
  blackOvTile(OVI.rel$tile,statistic = mean, "Goal Models, Relationships"),
  blackOvTile(OVI.conc.c$tile,statistic = mean, "Intention Models, Entities"),
  blackOvTile(OVI.rel.c$tile,statistic = mean, "Intention Models, Relationships")
) #+ theme(plot.margin = unit(c(1,1,1,1),"cm"))

if (printIMGData){
  ggsave(plot = F.7.3.Fig.tile,
         paste0(paperPath,"7.3.Fig-tile.pdf"), device = "pdf",
         width = 350, height = 200, units = "mm")
}

#
# Figures for 2-column paper
#

ovi.tile.obs1 = grid.arrange(
  blackOvTile(OVI.conc$tile,statistic = mean, "Goal Models, Entities"),
  blackOvTile(OVI.conc.c$tile,statistic = mean, "Intention Models, Entities")
) + theme(plot.margin = unit(c(1,1,1,1),"cm"))


ovi.tile.obs2 = grid.arrange(
  blackOvTile(OVI.rel$tile,statistic = mean, "Goal Models, Relationships"),
  blackOvTile(OVI.rel.c$tile,statistic = mean, "Intention Models, Relationships")
  ) + theme(plot.margin = unit(c(1,1,1,1),"cm"))

# also...
grid.arrange(
  blueOvTile(OVI.conc$tile),
  blueOvTile(OVI.rel$tile),
  blueOvTile(OVI.conc.c$tile),
  blueOvTile(OVI.rel.c$tile)
)


```






## Hypothesis O.2


```{r eval = FALSE}
 #####       #####  
#     #     #     # 
#     #           # 
#     #      #####  
#     # ### #       
#     # ### #       
 #####  ### ####### 


# Inferential Per Participant ------------------------
#
#' Inferential per participant is not possible due to their avoidance of multiple selections
#' To be resolved in the future rounds.
#'

observations %>% filter(language == "gmo") %>% rename("concept" = option, "n" = response) %>% 
    left_join(observations %>% group_by(participant,item) %>% summarise(n_s = sum(response)))

# ov_ratings_parti = ds1 %>% group_by(participant,item,psy_option,type) %>% 
#   summarise(n = sum(response)) %>% 
#   rename("concept" = psy_option) %>%
#   left_join(ds1 %>% group_by(participant,item) %>% summarise(n_s = sum(response))) 
# 
# ov_ratings_parti.c = ds1.c %>% group_by(participant,item,psy_option,type) %>% 
#   summarise(n = sum(response)) %>% 
#   rename("concept" = psy_option) %>%
#   left_join(ds1.c %>% group_by(participant,item) %>% summarise(n_s = sum(response))) 


areYouSure = FALSE
if (areYouSure) {
  OVP.conc = overlaps.per.participant(observations %>% filter(class =="concept"),l = "gmo",lang[["gmo"]][["concepts"]])
  OVP.conc.c = overlaps.per.participant(observations %>% filter(class =="concept"),l = "gme",lang[["gme"]][["concepts"]])
  OVP.rel = overlaps.per.participant(observations %>% filter(class == "relationship"),l = "gmo",lang[["gmo"]][["relationships"]])
  OVP.rel.c = overlaps.per.participant(observations %>% filter(class =="relationship"),l = "gme", lang[["gme"]][["relationships"]])
  saveRDS(OVP.conc, file="OVP.conc.RData")
  saveRDS(OVP.conc.c, file="OVP.conc.c.RData")
  saveRDS(OVP.rel, file="OVP.rel.RData")
  saveRDS(OVP.rel.c, file="OVP.rel.c.RData")
}

# OVP.conc$data %>% filter(overlap != 0) %>% select(participant,item,overlap)
# observations %>% filter(participant == "s.b10329bb-d348-4492-8736-ce27691770ac.txt", item == "descr1_item1_concepts")

OVP.conc = readRDS(file="OVP.conc.RData")
OVP.conc.c = readRDS(, file="OVP.conc.c.RData")
OVP.rel = readRDS(file="OVP.rel.RData")
OVP.rel.c = readRDS(file="OVP.rel.c.RData")

# Statistical Tests
OVP.ent.res = wilcox.test(OVP.conc$means %>% 
                            filter(pair == "Goal-Belief") %>% pull(Obs),
                          OVP.conc.c$means %>% 
                            filter(pair == "Goal-Objective") %>% pull(Obs), 
                          exact=FALSE,
                          alternative = "less")

OVP.rel.res = wilcox.test(OVP.rel$means %>% 
                            filter(pair == "wants-to-believes-that") %>% pull(Obs),
                          OVP.rel.c$means %>% 
                            filter(pair == "wants-to-intends-to") %>% pull(Obs),
                          exact=FALSE,
                          alternative = "less")


if (printTEXData) {
  sink(file = paste0(paperPath,"7.3. Ov-ent-res.tex"))
  cat(reportWilcox(OVP.ent.res,alpha = expAlphaLevel/ovExps))
  sink(file = NULL)

  sink(file = paste0(paperPath,"7.3. Ov-rel-res.tex"))
  cat(reportWilcox(OVP.rel.res,alpha = expAlphaLevel/ovExps))
  sink(file = NULL)
}
```



## Relationship to self-reported (S.3)

```{r }
 #####       #####  
#     #     #     # 
#                 # 
 #####       #####  
      # ###       # 
#     # ### #     # 
 #####  ###  #####  

# Correlation with self-reported ----------------------------------------------------

#
#
# ***  S C A T T E R   P L O T S  ***
#
#

# gmo - Entities
ovp.ratings.conc = 
  rbind(
    OVI.conc$stats %>% ungroup() %>% 
      mutate(Pair = paste(concept1, concept2, sep = "-"), Overlap = mean, Group = "Observed") %>% 
      select(Pair, Overlap, Group)
    ,
    ds2 %>% filter(concept %in% c("Actor-Belief","Goal-Belief","Actor-Goal")) %>% 
      select(concept,value) %>% 
      rename("Pair" = concept) %>% 
      group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>%
      mutate(Group = "Reported")
  )
# gmo - Relationships
ovp.ratings.rels = 
  rbind(
    OVI.rel$stats %>% ungroup() %>% 
      mutate(Pair = paste(concept1, concept2, sep = "-"), Overlap = mean, Group = "Observed") %>%
      select(Pair, Overlap, Group)
  ,
    ds2 %>% filter(concept %in% 
                     c("wants-to-believes-that",
                       "wants-to-is-a-means-to",
                       "wants-to-motivates",
                       "believes-that-is-a-means-to",
                       "believes-that-motivates",
                       "motivates-is-a-means-to"
                     ),
    ) %>% 
      select(concept,value) %>% 
      rename("Pair" = concept) %>% 
      group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>%
      mutate(Group = "Reported")
  )
# gme - Entities
ovp.ratings.conc.c = 
  rbind(
    OVI.conc.c$stats %>% ungroup() %>% 
      mutate(Pair = paste(concept1, concept2, sep = "-"), Overlap = mean, Group = "Observed", Ovi.sd = 0) %>%
      select(Pair, Overlap, Group, Ovi.sd)
  ,
    ds2.c %>% filter(concept %in% c("Organization-Objective","Goal-Objective","Organization-Goal")) %>% 
      select(concept,value) %>% 
      rename("Pair" = concept) %>% 
      group_by(Pair) %>% summarise(Overlap = mean(value)/10,Ovi.sd = sd(value/10)) %>%
      mutate(Group = "Reported")
  )
# gme - Relationships
ovp.ratings.rels.c = 
  rbind(
    OVI.rel.c$stats %>% ungroup() %>% 
      mutate(Pair = paste(concept1, concept2, sep = "-"), Overlap = mean, Group = "Observed") %>%
      select(Pair, Overlap, Group)
  ,
    ds2.c %>% filter(concept %in% 
                     c("wants-to-intends-to",
                       "wants-to-is-a-means-to",
                       "wants-to-prevents",
                       "intends-to-prevents",
                       "intends-to-is-a-means-to",
                       "intends-to-prevents",
                       "prevents-is-a-means-to")
    ) %>% 
    select(concept,value) %>% 
    rename("Pair" = concept) %>% 
    group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>%
    mutate(Group = "Reported")
  )
#




(self.ovi.conc = ggplot(ovp.ratings.conc %>% pivot_wider(names_from = Group,values_from = Overlap),
       aes(x=Observed, y=Reported, label=Pair)) +
  geom_label(size = 6) + geom_smooth(method='lm', formula= y~x,se=FALSE) +
 thema +
  #xlim(c(-0.02,1)) + ylim(c(0,1)) +
  #xlim(c(-0.02,0.32)) + ylim(c(0.00,0.4)) + 
  xlim(c(-0.12,0.67)) + ylim(c(0.00,0.8)) + 
  ylab("Reported Overlap (0.0-1.0)") + 
  xlab("Observed Overlap per Pair (OpP) (0.0-1.0)") +
  ggtitle("Goal Models: Entities"))
#
(self.ovi.rels = ggplot(ovp.ratings.rels %>% pivot_wider(names_from = Group,values_from = Overlap),
       aes(x=Observed, y=Reported, label=Pair)) + thema +
  geom_label(size = 6) + geom_smooth(method='lm', formula= y~x,se=FALSE) +
  #xlim(c(-0.02,0.075)) + ylim(c(0,0.9)) + 
  #xlim(c(-0.04,0.39)) +
  xlim(c(-0.12,0.67)) + ylim(c(0.00,0.8)) +
  ylab("Reported Overlap (0.0-1.0)") + 
  xlab("Observed per Pair (OpP) (0.0-1.0)") +
  ggtitle("Goal Models: Relationships"))
#

(self.ovi.conc.c = ggplot(ovp.ratings.conc.c %>% select(-Ovi.sd) %>% pivot_wider(names_from = Group,values_from = Overlap),
       aes(x=Observed, y=Reported, label=Pair)) +
  geom_label(size = 6) + geom_smooth(method='lm', formula= y~x,se=FALSE) +
  #xlim(c(-0.02,0.075)) + ylim(c(0,0.9)) +
  #xlim(c(-0.1,0.67)) + ylim(c(0.1,0.8)) + 
  xlim(c(-0.12,0.67)) + ylim(c(0.0,0.8)) + 
  thema+ 
  ylab("Reported Overlap (0.0-1.0)") + 
  xlab("Observed per Pair (OpP) (0.0-1.0)") +
  ggtitle("Intention Models: Entities"))
#
(self.ovi.rels.c = ggplot(ovp.ratings.rels.c %>% pivot_wider(names_from = Group,values_from = Overlap),
       aes(x=Observed, y=Reported, label=Pair)) +
  geom_label(size = 6) + geom_smooth(method='lm', formula= y~x,se=FALSE) +
  #xlim(c(-0.02,0.075)) + ylim(c(0,0.9)) + 
  xlim(c(-0.12,0.67)) + ylim(c(0,0.8)) + 
  thema + 
  ylab("Reported Overlap (0.0-1.0)") + 
  xlab("Observed per Pair (OpP) (0.0-1.0)") +
  ggtitle("Intention Models: Relationships"))


grid.arrange(self.ovi.conc,
             self.ovi.rels,
             self.ovi.conc.c,
             self.ovi.rels.c,nrow=2)


if (printIMGData) {
   ggsave(plot = grid.arrange(self.ovi.conc,
             self.ovi.rels,
             self.ovi.conc.c,
             self.ovi.rels.c,nrow=2),
          paste0(paperPath,"7.3.Fig-self.ov.pdf"), 
          width = 350, height = 180, units = "mm")
}


OVP.conc = readRDS(file="OVP.conc.RData")
OVP.conc.c = readRDS(file="OVP.conc.c.RData")
OVP.rel = readRDS(file="OVP.rel.RData")
OVP.rel.c = readRDS(file="OVP.rel.c.RData")

OVP.all = rbind(OVP.conc$means,OVP.conc.c$means,OVP.rel$means,OVP.rel.c$means) %>% ungroup() %>% select(participant,pair,Obs)
ds2.all = rbind(ds2,ds2.c) %>% 
      select(participant,concept,value) %>% 
      rename("pair" = concept) %>% 
      group_by(participant,pair) %>% summarise(Overlap = mean(value)/10)

ov.corr.data = OVP.all %>% inner_join(ds2.all) 

ov.corr.test = cor.test(
  ov.corr.data %>% pull(Obs),
  ov.corr.data %>% pull(Overlap),
  method = "kendall",exact = FALSE)

if (printTEXData) {
  sink(file = paste0(paperPath,"7.3. Ov-self.tex"))
  cat(reportKendalCor(ov.corr.test,alpha = expAlphaLevel/selfExps))
  sink(file = NULL)
}





#
#
# *** T I L E S ***
#
#

self.tile.conc = ds2 %>% 
  filter(psy_item %in% paste0("conceptOverlap:",1:3)) %>%
  select(concept,value) %>% 
  rename("Pair" = concept) %>% 
  group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>% separate(Pair , c("Concept1","Concept2"),"-")
self.tile.conc = rbind(self.tile.conc, self.tile.conc %>% rename("Concept1" = Concept2, "Concept2" = Concept1)) %>% rename("Obs" = Overlap) %>% 
  mutate(concept1 = factor(Concept1,levels = lang$gmo$concepts),
         concept2 = factor(Concept2,levels = lang$gmo$concepts))


self.tile.conc.c = ds2.c %>% 
  filter(psy_item %in% paste0("conceptOverlap:",1:3)) %>%
  select(concept,value) %>% 
  rename("Pair" = concept) %>% 
  group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>% separate(Pair , c("Concept1","Concept2"),"-")
self.tile.conc.c = rbind(self.tile.conc.c, self.tile.conc.c %>% rename("Concept1" = Concept2, "Concept2" = Concept1)) %>% rename("Obs" = Overlap) %>%
  mutate(concept1 = factor(Concept1,levels = lang$gme$concepts),
         concept2 = factor(Concept2,levels = lang$gme$concepts))


c1 = c(rep("believes-that",2),"motivates",rep("wants-to",3))
c2 = c("is-a-means-to","motivates","is-a-means-to","believes-that","is-a-means-to","motivates")

self.tile.rels = ds2 %>% 
  filter(psy_item %in% paste0("conceptOverlap:",4:9)) %>%
  select(concept,value) %>% 
  rename("Pair" = concept) %>% 
  group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>% mutate(Concept1 = c1,Concept2 = c2)
self.tile.rels = rbind(self.tile.rels, self.tile.rels %>% rename("Concept1" = Concept2, "Concept2" = Concept1)) %>% rename("Obs" = Overlap)%>%
  mutate(concept1 = factor(Concept1,levels = lang$gmo$relationships),
         concept2 = factor(Concept2,levels = lang$gmo$relationships))

c1 = c(rep("intends-to",2),"prevents",rep("wants-to",3))
c2 = c("is-a-means-to","prevents","is-a-means-to","intends-to","is-a-means-to","prevents")
self.tile.rels.c = ds2.c %>% 
  filter(psy_item %in% paste0("conceptOverlap:",4:9)) %>%
  select(concept,value) %>% 
  rename("Pair" = concept) %>% 
  group_by(Pair) %>% summarise(Overlap = mean(value)/10) %>% mutate(Concept1 = c1,Concept2 = c2)
self.tile.rels.c = rbind(self.tile.rels.c, self.tile.rels.c %>% rename("Concept1" = Concept2, "Concept2" = Concept1)) %>% rename("Obs" = Overlap)%>%
  mutate(concept1 = factor(Concept1,levels = lang$gme$relationships),
         concept2 = factor(Concept2,levels = lang$gme$relationships))

self.ovi.tile = grid.arrange(
  blackOvTile(self.tile.conc, statistic = Obs, title = "Goal Models, Entities (self-reported)"),
  blackOvTile(self.tile.rels, statistic = Obs, title ="Goal Models, Relationships (self-reported)"),
  blackOvTile(self.tile.conc.c, statistic = Obs, title ="Intention Models, Entities (self-reported)"),
  blackOvTile(self.tile.rels.c, statistic = Obs, title ="Intention Models, Relationships (self-reported)")
) 

# For comparison
grid::grid.draw(F.7.3.Fig.tile)

```



